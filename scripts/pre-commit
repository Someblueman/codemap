#!/usr/bin/env bash
set -euo pipefail

export PATH="$PATH:$HOME/go/bin"

if ! root="$(git rev-parse --show-toplevel 2>/dev/null)"; then
  exit 0
fi

# Only run when Go files are staged.
if ! git diff --cached --name-only --diff-filter=ACMR | grep -qE '\.go$'; then
  exit 0
fi

# codemap must be installed and available in PATH.
if ! command -v codemap >/dev/null 2>&1; then
  echo "codemap not installed; skipping CODEMAP.paths generation" >&2
  exit 0
fi

stage_if_not_ignored() {
  local path="$1"
  if git check-ignore -q "${path}"; then
    return 0
  fi
  git add "${path}" 2>/dev/null || true
}

(
  cd "${root}"
  codemap
  stage_if_not_ignored CODEMAP.md
  stage_if_not_ignored CODEMAP.paths
)
