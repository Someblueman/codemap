#!/usr/bin/env bash
set -euo pipefail

export PATH="$PATH:$HOME/go/bin"

if ! root="$(git rev-parse --show-toplevel 2>/dev/null)"; then
  exit 0
fi

# Only run when supported source files are staged.
if ! git diff --cached --name-only --diff-filter=ACMR | grep -qE '\.(go|py|rs|sh|bash|bats|ts|tsx|mts|cts)$'; then
  exit 0
fi

# codemap must be installed and available in PATH.
if ! command -v codemap >/dev/null 2>&1; then
  echo "codemap not installed; skipping CODEMAP.paths generation" >&2
  exit 0
fi

unstage_output() {
  local path="$1"
  git restore --staged --quiet -- "${path}" 2>/dev/null || true
  git reset -q -- "${path}" 2>/dev/null || true
  git rm --cached -q --ignore-unmatch -- "${path}" 2>/dev/null || true
}

(
  cd "${root}"
  codemap
  unstage_output CODEMAP.md
  unstage_output CODEMAP.paths
)
